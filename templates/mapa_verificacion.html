{% extends 'base.html' %}

{% block title %}Mapa de Verificaci√≥n - Reforest Go{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
{% endblock %}

{% block extra_style %}
<style>
    .verificacion-header {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        margin-bottom: 2rem;
    }
    
    .verificacion-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        color: #333;
    }
    
    .verificacion-header p {
        color: #666;
    }
    
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .stat-box {
        background: #f5f5f5;
        padding: 1.5rem;
        border-radius: 15px;
        text-align: center;
    }
    
    .stat-box .number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #4CAF50;
    }
    
    .stat-box .label {
        color: #666;
        margin-top: 0.5rem;
    }
    
    #map {
        width: 100%;
        height: 600px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        background: white;
        margin-bottom: 2rem;
    }
    
    .leaflet-popup-content {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-width: 250px;
    }
    
    .popup-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.8rem;
    }
    
    .popup-image {
        width: 100%;
        max-height: 200px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 0.8rem;
    }
    
    .popup-info {
        margin: 0.5rem 0;
        color: #666;
    }
    
    .popup-info strong {
        color: #333;
    }
    
    .btn-verificar {
        display: inline-block;
        width: 100%;
        padding: 0.8rem;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        margin-top: 0.8rem;
        transition: transform 0.2s;
    }
    
    .btn-verificar:hover {
        transform: translateY(-2px);
    }
    
    .info-panel {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .info-panel h3 {
        color: #4CAF50;
        margin-bottom: 1rem;
    }
    
    .info-panel ul {
        list-style: none;
        padding: 0;
    }
    
    .info-panel li {
        padding: 0.8rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .info-panel li:last-child {
        border-bottom: none;
    }
    
    .info-panel li::before {
        content: "‚úì ";
        color: #4CAF50;
        font-weight: bold;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="verificacion-header">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
        <div>
            <h1>üîç Verificaci√≥n de √Årboles</h1>
            <p>Encuentra √°rboles cercanos que necesitan verificaci√≥n y gana puntos</p>
        </div>
        <a href="{% url 'reforest:mis_verificaciones' %}" class="btn" style="background: linear-gradient(135deg, #29B6F6 0%, #0288D1 100%); padding: 0.8rem 1.5rem; text-decoration: none; color: white; border-radius: 25px; font-weight: 600; white-space: nowrap;">
            üìã Mis Verificaciones
        </a>
    </div>
    
    <div class="stats-row">
        <div class="stat-box">
            <div class="number">{{ total_pendientes }}</div>
            <div class="label">√Årboles por verificar</div>
        </div>
        <div class="stat-box">
            <div class="number">50</div>
            <div class="label">Puntos base</div>
        </div>
        <div class="stat-box">
            <div class="number">+30</div>
            <div class="label">Bonus precisi√≥n</div>
        </div>
        <div class="stat-box">
            <div class="number">+20</div>
            <div class="label">Bonus foto extra</div>
        </div>
    </div>
</div>

<!-- Contenedor para mapa y lista -->
<div style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem; margin-bottom: 2rem;">
    <div id="map"></div>
    
    <!-- Lista de √°rboles ordenada por distancia -->
    <div class="info-panel" style="max-height: 600px; overflow-y: auto;">
        <h3>üìç √Årboles Pendientes</h3>
        {% if tiene_ubicacion %}
            <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                Ordenados por distancia (m√°s cercano primero)
            </p>
        {% else %}
            <p style="color: #FFA500; font-size: 0.9rem; margin-bottom: 1rem;">
                ‚ö†Ô∏è Activa tu ubicaci√≥n para ver distancias
            </p>
        {% endif %}
        
        {% if siembras_lista %}
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for siembra in siembras_lista %}
                <div style="background: #f9f9f9; padding: 1rem; border-radius: 10px; border-left: 4px solid #4CAF50;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="font-size: 1.3rem;">üå≥</span>
                        <strong style="color: #333;">{{ siembra.especie }}</strong>
                    </div>
                    
                    {% if siembra.distancia %}
                    <div style="color: #4CAF50; font-size: 0.9rem; margin-bottom: 0.3rem;">
                        üìç {{ siembra.distancia_texto }}
                    </div>
                    {% endif %}
                    
                    <div style="color: #666; font-size: 0.85rem; margin-bottom: 0.3rem;">
                        üë§ {{ siembra.usuario }}
                    </div>
                    
                    <div style="color: #999; font-size: 0.85rem; margin-bottom: 0.8rem;">
                        üìÖ {{ siembra.fecha }}
                    </div>
                    
                    <a href="{% url 'reforest:verificar_arbol' siembra.id %}" 
                       style="display: block; 
                              text-align: center; 
                              padding: 0.6rem; 
                              background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); 
                              color: white; 
                              text-decoration: none; 
                              border-radius: 8px; 
                              font-weight: 600;
                              transition: transform 0.2s;"
                       onmouseover="this.style.transform='translateY(-2px)'"
                       onmouseout="this.style.transform='translateY(0)'">
                        üîç Verificar
                    </a>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 2rem; color: #999;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                <p>No hay √°rboles pendientes por verificar en este momento.</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="info-panel">
    <h3>üìã C√≥mo funciona la verificaci√≥n</h3>
    <ul>
        <li><strong>Encuentra un √°rbol cercano</strong> en el mapa o en la lista de la derecha</li>
        <li><strong>Los √°rboles m√°s cercanos aparecen primero</strong> para facilitar tu trabajo</li>
        <li><strong>Visita el √°rbol f√≠sicamente</strong> y toma fotos desde diferentes √°ngulos</li>
        <li><strong>Verifica la ubicaci√≥n</strong> usando el GPS de tu dispositivo</li>
        <li><strong>Env√≠a la verificaci√≥n</strong> con tus notas y observaciones</li>
        <li><strong>Gana puntos</strong> cuando un administrador apruebe tu verificaci√≥n</li>
        <li><strong>Bonificaciones:</strong> Precisi√≥n de ubicaci√≥n (+30 pts) y fotos adicionales (+20 pts)</li>
    </ul>
</div>

<style>
    @media (max-width: 968px) {
        div[style*="grid-template-columns: 1fr 350px"] {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Datos de siembras desde Django
    const siembrasData = JSON.parse('{{ siembras|escapejs }}');
    
    // Inicializar mapa centrado en Barrancabermeja
    const map = L.map('map').setView([7.0653, -73.8534], 13);
    
    // A√±adir capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18,
    }).addTo(map);
    
    // Icono personalizado para √°rboles pendientes
    const arbolIcon = L.divIcon({
        className: 'custom-icon',
        html: '<div style="background: #FFA500; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 3px 10px rgba(255,165,0,0.5); border: 3px solid white;">üå≥</div>',
        iconSize: [35, 35]
    });
    
    // A√±adir marcadores de √°rboles pendientes
    siembrasData.forEach(siembra => {
        const marker = L.marker([siembra.lat, siembra.lng], { icon: arbolIcon }).addTo(map);
        
        const popupContent = `
            <div class="popup-content">
                <div class="popup-title">üå≥ √Årbol por verificar</div>
                ${siembra.foto_url ? `<img src="${siembra.foto_url}" class="popup-image" alt="Foto del √°rbol">` : ''}
                <div class="popup-info"><strong>üåø Especie:</strong> ${siembra.especie}</div>
                <div class="popup-info"><strong>üë§ Plantado por:</strong> ${siembra.usuario}</div>
                <div class="popup-info"><strong>üìÖ Fecha:</strong> ${siembra.fecha}</div>
                <a href="/verificacion/arbol/${siembra.id}/" class="btn-verificar">
                    üîç Verificar este √°rbol
                </a>
            </div>
        `;
        
        marker.bindPopup(popupContent, {
            maxWidth: 300
        });
    });
    
    // Intentar obtener y usar la ubicaci√≥n del usuario
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                
                // Si no hay par√°metros de ubicaci√≥n en la URL, agregarlos (solo una vez)
                const urlParams = new URLSearchParams(window.location.search);
                const hasLatParam = urlParams.has('lat');
                const hasLngParam = urlParams.has('lng');
                const tieneUbicacion = {% if tiene_ubicacion %}true{% else %}false{% endif %};
                
                // Solo recargar si no tenemos ubicaci√≥n Y no hay par√°metros en la URL
                if (!tieneUbicacion && !hasLatParam && !hasLngParam) {
                    window.location.href = `?lat=${userLat}&lng=${userLng}`;
                    return;
                }
                
                // A√±adir marcador del usuario
                const userIcon = L.divIcon({
                    className: 'custom-icon',
                    html: '<div style="background: #2196F3; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; box-shadow: 0 3px 10px rgba(33,150,243,0.6); border: 3px solid white; animation: pulse 2s infinite;">üìç</div>',
                    iconSize: [35, 35]
                });
                
                L.marker([userLat, userLng], { icon: userIcon })
                    .addTo(map)
                    .bindPopup('<div style="text-align: center;"><strong>üìç Tu ubicaci√≥n actual</strong><br><small>Los √°rboles se ordenan desde aqu√≠</small></div>')
                    .openPopup();
                
                // Centrar mapa en el usuario si no hay √°rboles
                if (siembrasData.length === 0) {
                    map.setView([userLat, userLng], 14);
                }
            },
            (error) => {
                console.log('No se pudo obtener la ubicaci√≥n del usuario:', error.message);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000
            }
        );
    }
    
    // Si hay √°rboles, ajustar el zoom para mostrarlos todos
    if (siembrasData.length > 0) {
        const bounds = L.latLngBounds(siembrasData.map(s => [s.lat, s.lng]));
        map.fitBounds(bounds, { padding: [50, 50] });
    }
</script>
{% endblock %}
</document_content>