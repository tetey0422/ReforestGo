{% extends 'base.html' %}

{% block title %}Registrar Siembra - Reforest Go{% endblock %}

{% block extra_style %}
<style>
    .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        overflow: hidden;
    }
    
    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
    }
    
    .header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .header p {
        opacity: 0.9;
    }
    
    .form-container {
        padding: 2rem;
    }
    
    .gps-status {
        background: #f0f0f0;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .gps-status.success {
        background: #d4edda;
        color: #155724;
    }
    
    .gps-status.error {
        background: #f8d7da;
        color: #721c24;
    }
    
    .gps-status.loading {
        background: #fff3cd;
        color: #856404;
    }
    
    .spinner {
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0,0,0,0.1);
        border-top-color: #4CAF50;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }
    
    input[type="text"],
    input[type="file"],
    textarea {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }
    
    input:focus,
    textarea:focus {
        outline: none;
        border-color: #4CAF50;
    }
    
    textarea {
        resize: vertical;
        min-height: 100px;
    }
    
    .photo-preview {
        margin-top: 1rem;
        display: none;
    }
    
    .photo-preview img {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .submit-btn {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .submit-btn:hover {
        transform: translateY(-2px);
    }
    
    .submit-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
    }
    
    .info-box {
        background: #e3f2fd;
        border-left: 4px solid #2196F3;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 5px;
    }
    
    .info-box p {
        margin: 0;
        color: #1565c0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üå≥ Registrar Nueva Siembra</h1>
        <p>Captura tu √°rbol y suma puntos ecol√≥gicos</p>
    </div>
    
    <div class="form-container">
        <div id="gps-status" class="gps-status loading">
            <div class="spinner"></div>
            <span id="gps-message">Obteniendo ubicaci√≥n GPS...</span>
        </div>
        
        <div class="info-box">
            <p><strong>üí° Consejo:</strong> Cada √°rbol plantado te otorga 20 puntos ecol√≥gicos. ¬°Sigue plantando para subir de nivel!</p>
        </div>
        
        <form id="siembra-form" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <input type="hidden" id="latitud" name="latitud" value="">
            <input type="hidden" id="longitud" name="longitud" value="">
            
            <div class="form-group">
                <label for="foto">üì∏ Foto del √°rbol plantado *</label>
                <input type="file" id="foto" name="foto" accept="image/*" capture="environment" required>
                <div class="photo-preview" id="photo-preview">
                    <img id="preview-img" src="" alt="Vista previa">
                </div>
            </div>
            
            <div class="form-group">
                <label for="especie">üåø Especie del √°rbol (opcional)</label>
                <input type="text" id="especie" name="especie" placeholder="Ej: Ceiba, Guayac√°n, Roble...">
            </div>
            
            <div class="form-group">
                <label for="descripcion">üìù Descripci√≥n</label>
                <textarea id="descripcion" name="descripcion" placeholder="Describe tu siembra: ubicaci√≥n espec√≠fica, condiciones del terreno, etc."></textarea>
            </div>
            
            <button type="submit" class="submit-btn" id="submit-btn" disabled>
                üå± Registrar Siembra
            </button>
        </form>
    </div>
</div>

<script>
    let gpsObtenido = false;
    
    // Obtener ubicaci√≥n GPS autom√°ticamente
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                // √âxito al obtener GPS
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                document.getElementById('latitud').value = lat;
                document.getElementById('longitud').value = lng;
                
                const gpsStatus = document.getElementById('gps-status');
                const gpsMessage = document.getElementById('gps-message');
                const submitBtn = document.getElementById('submit-btn');
                
                gpsStatus.className = 'gps-status success';
                gpsMessage.textContent = `‚úÖ Ubicaci√≥n obtenida: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                submitBtn.disabled = false;
                gpsObtenido = true;
            },
            (error) => {
                // Error al obtener GPS
                const gpsStatus = document.getElementById('gps-status');
                const gpsMessage = document.getElementById('gps-message');
                
                gpsStatus.className = 'gps-status error';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        gpsMessage.textContent = '‚ùå Debes permitir el acceso a tu ubicaci√≥n para registrar la siembra.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        gpsMessage.textContent = '‚ùå No se pudo determinar tu ubicaci√≥n.';
                        break;
                    case error.TIMEOUT:
                        gpsMessage.textContent = '‚ùå Tiempo de espera agotado al obtener ubicaci√≥n.';
                        break;
                    default:
                        gpsMessage.textContent = '‚ùå Error desconocido al obtener ubicaci√≥n.';
                }
            }
        );
    } else {
        const gpsStatus = document.getElementById('gps-status');
        const gpsMessage = document.getElementById('gps-message');
        
        gpsStatus.className = 'gps-status error';
        gpsMessage.textContent = '‚ùå Tu navegador no soporta geolocalizaci√≥n.';
    }
    
    // Vista previa de la foto
    document.getElementById('foto').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('photo-preview');
                const previewImg = document.getElementById('preview-img');
                previewImg.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Validaci√≥n antes de enviar
    document.getElementById('siembra-form').addEventListener('submit', function(e) {
        if (!gpsObtenido) {
            e.preventDefault();
            alert('‚ö†Ô∏è Debes permitir el acceso a tu ubicaci√≥n para registrar la siembra.');
            return false;
        }
        
        const foto = document.getElementById('foto').files[0];
        if (!foto) {
            e.preventDefault();
            alert('‚ö†Ô∏è Debes subir una foto del √°rbol plantado.');
            return false;
        }
        
        // Deshabilitar bot√≥n para evitar doble env√≠o
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').textContent = '‚è≥ Registrando...';
    });
</script>
{% endblock %}